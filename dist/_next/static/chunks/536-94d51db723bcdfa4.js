"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[536],{3536:function(e,t,a){a.r(t),a.d(t,{default:function(){return m}});var o=a(5893),c=a(7017),l=a(4905),n=a(7294),i=a(6078),r=a(4696);let{Title:s,Text:d}=l.Typography,u=[{name:"视频ID",type:c.fS.Text,desc:"aweme_id"},{name:"分享链接",type:c.fS.Text,desc:"share_url / params.share_url"},{name:"视频描述",type:c.fS.Text,desc:"desc / content_desc"},{name:"语言",type:c.fS.Text,desc:"desc_language"},{name:"国家/地区",type:c.fS.Text,desc:"region"},{name:"发布时间戳",type:c.fS.Number,desc:"create_time"},{name:"作者UID",type:c.fS.Text,desc:"author.uid"},{name:"作者sec_uid",type:c.fS.Text,desc:"author.sec_uid"},{name:"作者昵称",type:c.fS.Text,desc:"author.nickname"},{name:"作者唯一ID",type:c.fS.Text,desc:"author.unique_id"},{name:"作者简介",type:c.fS.Text,desc:"author.signature"},{name:"作者地区",type:c.fS.Text,desc:"author.region"},{name:"作者粉丝数",type:c.fS.Number,desc:"author.follower_count"},{name:"作者获赞总数",type:c.fS.Number,desc:"author.total_favorited"},{name:"音乐标题",type:c.fS.Text,desc:"music.title"},{name:"音乐作者",type:c.fS.Text,desc:"music.author"},{name:"音乐原声",type:c.fS.Checkbox,desc:"music.is_original_sound"},{name:"音乐商业版权",type:c.fS.Checkbox,desc:"music.is_commerce_music"},{name:"播放量",type:c.fS.Number,desc:"statistics.play_count"},{name:"点赞数",type:c.fS.Number,desc:"statistics.digg_count"},{name:"评论数",type:c.fS.Number,desc:"statistics.comment_count"},{name:"分享数",type:c.fS.Number,desc:"statistics.share_count"},{name:"收藏数",type:c.fS.Number,desc:"statistics.collect_count"},{name:"下载数",type:c.fS.Number,desc:"statistics.download_count"},{name:"视频时长毫秒",type:c.fS.Number,desc:"video.duration"},{name:"视频宽度",type:c.fS.Number,desc:"video.width"},{name:"视频高度",type:c.fS.Number,desc:"video.height"},{name:"封面URL",type:c.fS.Text,desc:"video.origin_cover.url_list[0]"},{name:"无水印视频URL",type:c.fS.Text,desc:"video.download_no_watermark_addr.url_list[0]"},{name:"封面附件",type:c.fS.Attachment,desc:"封面图片附件"},{name:"无水印视频附件",type:c.fS.Attachment,desc:"无水印视频附件"},{name:"是否AI生成内容",type:c.fS.Checkbox,desc:"aigc_info.created_by_ai"},{name:"接口请求时间",type:c.fS.Text,desc:"time"},{name:"接口请求ID",type:c.fS.Text,desc:"request_id"},{name:"接口状态码",type:c.fS.Number,desc:"code / data.status_code"},{name:"接口消息",type:c.fS.Text,desc:"message_zh / status_msg"}];function m(){let[e,t]=(0,n.useState)(),[a,m]=(0,n.useState)(!1),[y,h]=(0,n.useState)(0),[g,f]=(0,n.useState)(""),_=(0,n.useRef)();(0,n.useCallback)(async e=>{let{table:t}=e;if(!t){l.FN.error("请先选择数据表");return}m(!0),f("正在创建/检查字段...");try{let e=await c.ws.base.getTableById(t),a=await e.getFieldList(),o=0,n=0;for(let t of u){let c=null;for(let e of a)try{let a=await e.getName();if(a===t.name){c=e;break}}catch(e){}if(c){n++;continue}let l=await (0,i.Hl)(e,a,t.name,t.type);l&&(o++,a=await e.getFieldList())}let r="字段初始化完成，新建 ".concat(o," 个字段，已存在 ").concat(n," 个字段");l.FN.success(r),f(r)}catch(e){console.error("初始化字段失败:",e),l.FN.error("初始化字段失败: ".concat(e.message||"未知错误")),f("初始化字段失败: ".concat(e.message||"未知错误"))}finally{m(!1)}},[]);let p=e=>{if(!e)return null;let t=e.match(/https?:\/\/[^\s]+/);return t?t[0].replace(/[)\]\uFF09\u3001\u3002\uFF0C]+$/u,""):null},w=(0,n.useCallback)(async e=>{let{table:t}=e;if(!t){l.FN.error("请先选择数据表");return}m(!0),h(0),f("开始根据分享链接获取社媒数据...");try{let e=await c.ws.base.getTableById(t),N=await e.getFieldList(),j=null;for(let e of N)try{let t=await e.getName();if("分享链接"===t||"share_url"===t||"分享链接(短链)"===t){j=e;break}}catch(e){}if(!j)try{j=await e.getFieldByName("分享链接")}catch(t){try{j=await e.getFieldByName("share_url")}catch(e){}}if(!j){l.FN.error("数据表中未找到“分享链接”或 share_url 字段，无法获取数据"),m(!1);return}let A=N;for(let t of u){let a=null;for(let e of A)try{let o=await e.getName();if(o===t.name){a=e;break}}catch(e){}a||(await (0,i.Hl)(e,A,t.name,t.type),A=await e.getFieldList())}let I=await Promise.all(A.map(async e=>{try{return await e.getName()}catch(e){return}}));console.log("当前表格所有字段名:",I);let D=await e.getRecords({pageSize:5e3}),F=D.records.length,C=0,L=0,U=0,R=null,V=null,z=null;for(let e of A)try{let t=await e.getName();"视频ID"===t||"video_id"===t||"aweme_id"===t?R=e:"封面附件"===t?V=e:"无水印视频附件"===t&&(z=e)}catch(e){}for(let t=0;t<F;t++){let c=D.records[t],l=c.recordId;h(Math.round((t+1)/F*100)),f("处理记录 ".concat(t+1,"/").concat(F,"..."));try{var a,o,n,s,d,y,g,_,w,v,b,S,x,T,k;if(R)try{let t=await e.getCellString(R.id,l);if(t&&t.trim()){let a=!1,o=!1;if(V)try{let t=await e.getCellValue(V.id,l);a=Array.isArray(t)&&t.length>0}catch(e){}if(z)try{let t=await e.getCellValue(z.id,l);o=Array.isArray(t)&&t.length>0}catch(e){}if(a&&o){console.log("记录 ".concat(l," 视频ID已存在 (").concat(t,") 且附件已上传，跳过")),L++;continue}console.log("记录 ".concat(l," 视频ID已存在 (").concat(t,")，但附件缺失（封面: ").concat(a,", 视频: ").concat(o,"），继续处理以补充附件"))}}catch(e){}let c=await e.getCellString(j.id,l),u=(c||"").trim();if(!u){L++;continue}let m=p(u);if(!m){L++;continue}let h=await fetch(r._i,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({share_url:m})}),N=await h.json();if(console.log("记录 ".concat(l," API 响应:"),{status:h.status,code:N.code,hasData:!!N.data,message:N.message||N.message_zh}),200!==h.status||0!==N.code&&200!==N.code||!N.data){U++,console.warn("记录 ".concat(l," 获取数据失败:"),N);continue}let I=N.data;console.log("记录 ".concat(l," API 返回数据:"),JSON.stringify(I).substring(0,500));let D=null;try{if(I&&"string"==typeof I.data){let e=JSON.parse(I.data);D=(null==e?void 0:e.aweme_detail)||null}else I&&"object"==typeof I.data&&I.data?D=I.data.aweme_detail||null:I&&I.aweme_detail&&(D=I.aweme_detail)}catch(e){console.error("记录 ".concat(l," 解析 data.aweme_detail 失败:"),e)}if(!D){console.warn("记录 ".concat(l," 未获取到 aweme_detail，跳过。apiData 结构:"),{hasData:!!I,dataType:typeof(null==I?void 0:I.data),hasAwemeDetail:!!(null==I?void 0:I.aweme_detail)}),L++;continue}console.log("记录 ".concat(l," 成功解析 aweme_detail，视频ID: ").concat(D.aweme_id));let O=D.author||{},B=D.music||{},P=D.statistics||{},W=D.video||{},q=D.aigc_info||{},E=null;if(W.bit_rate&&Array.isArray(W.bit_rate)&&W.bit_rate.length>0){let e=W.bit_rate.find(e=>3===e.quality_type)||W.bit_rate[0];(null==e?void 0:null===(d=e.play_addr)||void 0===d?void 0:d.url_list)&&Array.isArray(e.play_addr.url_list)&&e.play_addr.url_list.length>0&&(E=e.play_addr.url_list[0])}E||(E=(null===(g=W.download_no_watermark_addr)||void 0===g?void 0:null===(y=g.url_list)||void 0===y?void 0:y[0])||(null===(w=W.download_addr)||void 0===w?void 0:null===(_=w.url_list)||void 0===_?void 0:_[0])||(null===(b=W.play_addr)||void 0===b?void 0:null===(v=b.url_list)||void 0===v?void 0:v[0])||null);let H={视频ID:D.aweme_id||D.aweme_id_str,视频描述:D.desc||D.content_desc||D.caption,语言:D.desc_language,"国家/地区":D.region,发布时间戳:D.create_time,作者UID:O.uid,作者sec_uid:O.sec_uid,作者昵称:O.nickname,作者唯一ID:O.unique_id,作者简介:O.signature,作者地区:O.region,作者粉丝数:O.follower_count,作者获赞总数:O.total_favorited,音乐标题:B.title,音乐作者:B.author||B.owner_nickname,音乐原声:B.is_original_sound,音乐商业版权:B.is_commerce_music,播放量:P.play_count,点赞数:P.digg_count,评论数:P.comment_count,分享数:P.share_count,收藏数:P.collect_count,下载数:P.download_count,视频时长毫秒:W.duration,视频宽度:W.width,视频高度:W.height,封面URL:(null===(o=W.origin_cover)||void 0===o?void 0:null===(a=o.url_list)||void 0===a?void 0:a[0])||(null===(s=W.cover)||void 0===s?void 0:null===(n=s.url_list)||void 0===n?void 0:n[0])||null,无水印视频URL:E,是否AI生成内容:q.created_by_ai||!1,接口请求时间:I.time,接口请求ID:I.request_id,接口状态码:I.code,接口消息:I.message_zh||I.message},J={},M=[],G={};for(let e of A)try{let t=await e.getName();G[t]=e}catch(e){}for(let[e,t]of Object.entries(H)){let a=G[e];if(!a){M.push(e);continue}try{let e=await (0,i.Gv)(a,t);J[a.id]=e}catch(t){console.error("记录 ".concat(l," 字段 ").concat(e," 转换失败:"),t)}}if(M.length>0&&console.warn("记录 ".concat(l," 缺少字段:"),M),0===Object.keys(J).length){console.error("记录 ".concat(l," 没有可更新的字段，updateMap 为空")),U++;continue}try{console.log("记录 ".concat(l," 准备保存数据，字段数: ").concat(Object.keys(J).length)),await e.setRecord(l,{fields:J}),console.log("记录 ".concat(l," 数据保存成功"));let a=(null===(x=W.origin_cover)||void 0===x?void 0:null===(S=x.url_list)||void 0===S?void 0:S[0])||(null===(k=W.cover)||void 0===k?void 0:null===(T=k.url_list)||void 0===T?void 0:T[0])||null,o=G["封面附件"];if(a&&o&&"string"==typeof a&&a.startsWith("http"))try{f("正在下载封面图片 ".concat(t+1,"/").concat(F,"...")),console.log("记录 ".concat(l," 开始下载封面: ").concat(a));let e=new AbortController,c=setTimeout(()=>e.abort(),3e4),n=await fetch(a,{signal:e.signal});if(clearTimeout(c),n.ok){let e=await n.blob(),t="cover_".concat(D.aweme_id||Date.now(),".").concat(e.type.includes("png")?"png":"jpg"),a=new File([e],t,{type:e.type||"image/jpeg"});await o.setValue(l,a),console.log("✅ 记录 ".concat(l," 封面附件上传成功: ").concat(t," (").concat(e.size," bytes)"))}else console.warn("记录 ".concat(l," 下载封面失败: ").concat(n.status," ").concat(n.statusText))}catch(e){"AbortError"===e.name?console.warn("记录 ".concat(l," 下载封面超时")):console.error("记录 ".concat(l," 上传封面附件失败:"),e)}else a?o?console.log("记录 ".concat(l," 封面URL格式不正确: ").concat(a)):console.log("记录 ".concat(l," 无封面附件字段，跳过封面附件上传")):console.log("记录 ".concat(l," 无封面URL，跳过封面附件上传"));let c=G["无水印视频附件"];if(console.log("记录 ".concat(l," 检查视频附件上传条件:"),{hasVideoUrl:!!E,videoUrlType:typeof E,videoUrlValue:E,startsWithHttp:!!E&&"string"==typeof E&&E.startsWith("http"),hasVideoAttachmentField:!!c}),E&&c&&"string"==typeof E&&E.startsWith("http"))try{f("正在下载视频 ".concat(t+1,"/").concat(F,"...")),console.log("记录 ".concat(l," 开始下载无水印视频: ").concat(E));let e=new AbortController,a=setTimeout(()=>e.abort(),12e4),o="".concat(r.Pj,"?url=").concat(encodeURIComponent(E)),n=await fetch(o,{signal:e.signal});if(clearTimeout(a),n.ok){let e=await n.blob(),t="video_".concat(D.aweme_id||Date.now(),".mp4"),a=new File([e],t,{type:"video/mp4"});await c.setValue(l,a),console.log("✅ 记录 ".concat(l," 无水印视频附件上传成功: ").concat(t," (").concat(e.size," bytes)"))}else console.warn("记录 ".concat(l," 下载视频失败: ").concat(n.status," ").concat(n.statusText))}catch(e){"AbortError"===e.name?console.warn("记录 ".concat(l," 下载视频超时")):console.error("记录 ".concat(l," 上传视频附件失败:"),e)}else E?c?"string"!=typeof E?console.log("记录 ".concat(l," 无水印视频URL类型不正确: ").concat(typeof E,", 值: ").concat(E)):E.startsWith("http")||console.log("记录 ".concat(l," 无水印视频URL不是http/https链接: ").concat(E)):console.log("记录 ".concat(l," 无水印视频附件字段不存在，跳过视频附件上传")):console.log("记录 ".concat(l," 无水印视频URL，跳过视频附件上传"));C++}catch(e){console.error("记录 ".concat(l," 保存数据失败:"),e),U++}}catch(e){U++,console.error("记录 ".concat(l," 获取或写入社媒数据失败:"),e)}}let O="社媒数据获取完成：成功 ".concat(C," 条，跳过 ").concat(L," 条，失败 ").concat(U," 条");l.FN.success(O),f(O)}catch(e){console.error("社媒数据获取流程失败:",e),l.FN.error("社媒数据获取失败: ".concat(e.message||"未知错误")),f("社媒数据获取失败: ".concat(e.message||"未知错误"))}finally{m(!1),h(0)}},[]);return(0,n.useEffect)(()=>{Promise.all([c.ws.base.getTableMetaList(),c.ws.base.getSelection()]).then(e=>{var a;let[o,c]=e;t(o);let l=o.find(e=>"社媒数据获取"===e.name),n=(null==l?void 0:l.id)||c.tableId;n&&(null===(a=_.current)||void 0===a||a.setValues({table:n}))})},[]),(0,o.jsxs)("div",{children:[(0,o.jsx)(s,{heading:4,style:{marginBottom:"1rem"},children:"TikTok 社媒数据获取"}),(0,o.jsx)(d,{type:"tertiary",style:{marginBottom:"1rem",display:"block"},children:"通过 TikTok 或抖音的分享链接，自动获取视频的详细数据，包括播放量、点赞数、评论数、作者信息等，并自动下载封面图和无水印视频，帮助您快速收集和分析热门内容。"}),(0,o.jsxs)(l.l0,{getFormApi:e=>_.current=e,style:{width:"100%"},children:[(0,o.jsx)(l.l0.Slot,{label:"使用说明",children:(0,o.jsxs)("div",{style:{marginBottom:"1rem",fontSize:"14px",color:"#666",lineHeight:"1.6"},children:[(0,o.jsxs)("div",{children:[(0,o.jsx)("strong",{children:"功能说明："})," 根据分享链接自动获取 TikTok 或抖音视频的完整数据，包括视频信息、作者信息、统计数据等，并自动下载封面图和无水印视频作为附件"]}),(0,o.jsxs)("div",{style:{marginTop:"0.5rem"},children:[(0,o.jsx)("strong",{children:"操作步骤："}),(0,o.jsxs)("div",{style:{marginLeft:"1rem",marginTop:"0.25rem"},children:[(0,o.jsx)("div",{children:"1. 在数据表的“分享链接”字段中填写 TikTok 或抖音视频的分享链接"}),(0,o.jsx)("div",{children:"2. 选择包含分享链接的数据表"}),(0,o.jsx)("div",{children:"3. 点击“根据分享链接获取数据”按钮"}),(0,o.jsx)("div",{children:"4. 系统会自动识别链接类型（TikTok/抖音），获取数据并保存到对应字段"})]})]}),(0,o.jsx)("div",{style:{marginTop:"0.5rem",color:"#1890ff",fontWeight:"500"},children:"\uD83D\uDCA1 提示：系统会自动识别 TikTok 和抖音链接类型，并调用相应的 API 获取数据。如果视频ID字段不为空，将跳过该记录。系统会自动下载封面图和无水印视频并保存为附件。"}),(0,o.jsx)("div",{style:{marginTop:"0.5rem",color:"#fa8c16",fontWeight:"500"},children:"⚠️ 注意：分享链接字段不会被修改，系统只会读取链接并获取数据。如果记录已有视频ID，将自动跳过。"})]})}),(0,o.jsxs)(l.T,{vertical:!0,spacing:"loose",style:{width:"100%"},children:[(0,o.jsx)(l.l0.Select,{field:"table",label:"选择数据表",placeholder:"请选择数据表",style:{width:"100%"},rules:[{required:!0,message:"请选择数据表"}],children:Array.isArray(e)&&e.map(e=>{let{name:t,id:a}=e;return(0,o.jsx)(l.l0.Select.Option,{value:a,children:t},a)})}),(0,o.jsx)(l.zx,{theme:"solid",type:"secondary",loading:a,style:{width:"100%"},onClick:()=>{var e;let t=(null===(e=_.current)||void 0===e?void 0:e.getValues())||{};w({table:t.table})},children:"根据分享链接获取数据"}),a&&(0,o.jsx)(l.Ex,{percent:y,showInfo:!0}),g&&(0,o.jsx)(d,{type:"tertiary",children:g})]})]})]})}}}]);