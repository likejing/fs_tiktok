"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[733],{2733:function(e,t,o){o.r(t),o.d(t,{default:function(){return g}});var n=o(5893),c=o(7017),r=o(4905),a=o(7294),l=o(4696),i=o(6078);async function s(e,t,o){try{let n=await e.getRecords({pageSize:5e3});for(let c of(console.log("开始查找已存在的账号，open_id: ".concat(o,"，共 ").concat(n.records.length," 条记录")),n.records))try{let n=await (0,i.o$)(e,t,c.recordId),r=String(o||"").trim(),a=String(n||"").trim();if(console.log('比较 open_id - 当前: "'.concat(r,'", 记录中的: "').concat(a,'" (recordId: ').concat(c.recordId,")")),a&&r&&a===r)return console.log("✅ 找到已存在的账号，recordId: ".concat(c.recordId,", open_id: ").concat(o)),c.recordId}catch(e){console.warn("获取记录 ".concat(c.recordId," 的open_id失败:"),e);continue}return console.log("未找到已存在的账号，将新增，open_id: ".concat(o)),null}catch(e){return console.warn("查找已存在记录时出错，将直接新增:",e),null}}let{Title:d,Text:h}=r.Typography,u={username:"用户名",display_name:"账号展示名",profile_image:"头像链接",followers_count:"粉丝数",total_likes:"获赞数",videos_count:"视频数",following_count:"关注数"};function g(){let[e,t]=(0,a.useState)(),[o,g]=(0,a.useState)(""),[m,y]=(0,a.useState)(!1),[p,f]=(0,a.useState)(!1),w=(0,a.useRef)(),x=(0,a.useCallback)(async()=>{try{if(navigator.clipboard&&navigator.clipboard.writeText)try{await navigator.clipboard.writeText(l.h3),r.FN.success("TikTok授权链接已复制到剪贴板！");return}catch(e){console.warn("Clipboard API 失败，尝试降级方案:",e)}let e=document.createElement("textarea");if(e.value=l.h3,e.style.position="fixed",e.style.top="0",e.style.left="0",e.style.width="2em",e.style.height="2em",e.style.padding="0",e.style.border="none",e.style.outline="none",e.style.boxShadow="none",e.style.background="transparent",e.style.opacity="0",e.setAttribute("readonly",""),e.setAttribute("aria-hidden","true"),document.body.appendChild(e),navigator.userAgent.match(/ipad|iphone/i)){let t=document.createRange();t.selectNodeContents(e);let o=window.getSelection();o&&(o.removeAllRanges(),o.addRange(t)),e.setSelectionRange(0,999999)}else e.select(),e.setSelectionRange(0,999999);try{let e=document.execCommand("copy");if(e)r.FN.success("TikTok授权链接已复制到剪贴板！");else throw Error("execCommand 返回 false")}catch(t){console.error("execCommand 复制失败:",t),r.FN.warning("自动复制失败，请手动选择下方链接进行复制");let e=document.getElementById("tiktok-auth-link-input");e&&(e.focus(),e.select())}finally{document.body.removeChild(e)}}catch(t){console.error("复制失败:",t),r.FN.warning("自动复制失败，请手动选择下方链接进行复制");let e=document.getElementById("tiktok-auth-link-input");e&&(e.focus(),e.select())}},[]),j=(0,a.useCallback)(()=>{window.open(l.h3,"_blank")},[]),k=(0,a.useCallback)(async e=>{let{table:t,jsonData:o}=e;if(!t){r.FN.error("请先选择账号列表");return}if(!o||!o.trim()){r.FN.error("请输入JSON数据");return}y(!0);try{var n;let e;try{e=JSON.parse(o.trim())}catch(e){r.FN.error("JSON格式错误，请检查数据格式"),y(!1);return}let a=await c.ws.base.getTableById(t),l=await a.getFieldList(),d={};if(e&&"object"==typeof e)d=e.data&&"object"==typeof e.data?e.data:e;else{r.FN.error("JSON数据格式不正确，未找到data对象"),y(!1);return}if(!d.open_id){r.FN.error("JSON数据中未找到open_id字段，无法判断账号是否已存在"),y(!1);return}let h=await (0,i.Hl)(a,l,"open_id",c.fS.Text);if(!h){r.FN.error("无法创建或获取open_id字段，无法判断账号是否已存在"),y(!1);return}l=await a.getFieldList();let m={};for(let[e,t]of Object.entries(d))try{if("open_id"===e&&h){let o=String(t);m[h.id]=o,console.log("字段 ".concat(e," (").concat(h.id,") 保存值:"),o);continue}let o=u[e]||e,n=await (0,i.Hl)(a,l,o,(0,i.tI)(t));if(!n){console.warn("字段 ".concat(e," -> ").concat(o," 不存在且创建失败，跳过"));continue}let c=await (0,i.Gv)(n,t);null!=c&&(m[n.id]=c,console.log("字段 ".concat(e," -> ").concat(o," (").concat(n.id,") 保存值:"),c))}catch(t){console.error("处理字段 ".concat(e," 时出错:"),t),r.FN.error("处理字段 ".concat(e," 时出错: ").concat(t))}if(0===Object.keys(m).length){r.FN.warning("未找到可保存的字段。已解析的字段: ".concat(Object.keys(d).join(", "))),y(!1);return}console.log("准备保存的字段数据:",m);let p=d.open_id,f=await s(a,h,p);f?(await a.setRecord(f,{fields:m}),r.FN.success("账号已更新！open_id: ".concat(p))):(await a.addRecord({fields:m}),r.FN.success("新账号已添加！open_id: ".concat(p))),g(""),null===(n=w.current)||void 0===n||n.setValue("jsonData","")}catch(e){console.error("保存数据失败:",e),r.FN.error("保存失败: ".concat(e.message||"未知错误"))}finally{y(!1)}},[]),b=(0,a.useCallback)(async()=>{f(!0);try{let e=await c.ws.base.getActiveTable();if(!e){r.FN.error("请先选择账号列表"),f(!1);return}let t=await e.getFieldList(),o=t.find(e=>"access_token"===e.name),n=t.find(e=>"open_id"===e.name);if(!o)try{o=await e.getFieldByName("access_token")}catch(e){console.warn("access_token字段不存在")}if(!n)try{n=await e.getFieldByName("open_id")}catch(e){console.warn("open_id字段不存在")}if(!o){r.FN.error("表格中未找到 access_token 字段，无法更新账号信息"),f(!1);return}if(!n){r.FN.error("表格中未找到 open_id 字段，无法更新账号信息"),f(!1);return}let a=async(o,n,c)=>{if(!n||!c)return!1;let r="".concat(l.cZ,"?access_token=").concat(encodeURIComponent(n),"&open_id=").concat(encodeURIComponent(c));console.log("请求账号信息，URL: ".concat(r.replace(/access_token=[^&]+/,"access_token=***")));let a=await fetch(r);if(!a.ok){let e=await a.text();throw Error("请求失败: ".concat(a.status," ").concat(a.statusText," - ").concat(e))}let s=await a.json();if(0!==s.code&&s.error)throw Error(s.error+(s.details?": ".concat(s.details):""));if(!s.data)throw Error("接口返回数据格式错误，未找到data字段");let d=s.data,h={};for(let[o,n]of Object.entries(d))try{let c=u[o]||o,r=await (0,i.Hl)(e,t,c,(0,i.tI)(n));if(!r){console.warn("字段 ".concat(o," -> ").concat(c," 不存在且创建失败，跳过"));continue}let a=await (0,i.Gv)(r,n);null!=a&&(h[r.id]=a,console.log("字段 ".concat(o," -> ").concat(c," (").concat(r.id,") 更新值:"),a))}catch(e){console.error("处理字段 ".concat(o," 时出错:"),e)}return Object.keys(h).length>0&&(await e.setRecord(o,{fields:h}),!0)};r.FN.info("开始更新所有账号信息，请稍候...");let s=await e.getRecords({pageSize:5e3}),d=s.records.length;console.log("开始更新 ".concat(d," 条记录"));let h=0,g=0,m=0;for(let t=0;t<s.records.length;t++){let c=s.records[t],l=c.recordId;try{let c=null,s=null;if(o&&(c=await (0,i.o$)(e,o,l)),n&&(s=await (0,i.o$)(e,n,l)),!c||!s){let e=[];c||e.push("access_token"),s||e.push("open_id"),console.log("记录 ".concat(t+1,"/").concat(d," (").concat(l,") 缺少 ").concat(e.join(" 和 "),"，跳过")),g++;continue}console.log("更新记录 ".concat(t+1,"/").concat(d," (").concat(l,")..."));let u=await a(l,c,s);u?(h++,console.log("✅ 记录 ".concat(t+1,"/").concat(d," 更新成功"))):g++,(t+1)%10==0&&r.FN.info("已更新 ".concat(t+1,"/").concat(d," 条记录..."))}catch(e){m++,console.error("更新记录 ".concat(t+1,"/").concat(d," (").concat(l,") 失败:"),e)}}let y="更新完成！成功: ".concat(h,"，跳过: ").concat(g,"，失败: ").concat(m);0===m?r.FN.success(y):r.FN.warning(y),console.log("更新完成 - 总计: ".concat(d,", 成功: ").concat(h,", 跳过: ").concat(g,", 失败: ").concat(m))}catch(e){console.error("更新账号信息失败:",e),r.FN.error("更新失败: ".concat(e.message||"未知错误"))}finally{f(!1)}},[]);return(0,a.useEffect)(()=>{Promise.all([c.ws.base.getTableMetaList(),c.ws.base.getSelection()]).then(e=>{var o,n;let[c,r]=e;t(c);let a=(null===(o=c.find(e=>"账号列表"===e.name))||void 0===o?void 0:o.id)||r.tableId;null===(n=w.current)||void 0===n||n.setValues({table:a})})},[]),(0,n.jsxs)("div",{children:[(0,n.jsx)(d,{heading:4,style:{marginBottom:"1rem"},children:"TikTok 账号管理"}),(0,n.jsx)(h,{type:"tertiary",style:{marginBottom:"1rem",display:"block"},children:"管理您的 TikTok 账号信息，包括授权绑定、账号信息同步、粉丝数据更新等功能。"}),(0,n.jsxs)(r.l0,{labelPosition:"top",onSubmit:k,getFormApi:e=>w.current=e,style:{marginTop:"1rem"},children:[(0,n.jsx)(r.l0.Slot,{label:"新增账号 - 操作步骤",children:(0,n.jsxs)("div",{style:{marginBottom:"1rem",fontSize:"14px",color:"#666",lineHeight:"1.6"},children:[(0,n.jsxs)("div",{children:[(0,n.jsx)("strong",{children:"步骤 1："})," 点击下方“复制链接”按钮，复制 TikTok 授权链接"]}),(0,n.jsxs)("div",{children:[(0,n.jsx)("strong",{children:"步骤 2："})," 在浏览器中打开链接，使用 TikTok 账号完成授权"]}),(0,n.jsxs)("div",{children:[(0,n.jsx)("strong",{children:"步骤 3："})," 授权完成后，将返回的 JSON 数据粘贴到下方输入框"]}),(0,n.jsxs)("div",{children:[(0,n.jsx)("strong",{children:"步骤 4："})," 选择要保存账号的数据表（账号列表）"]}),(0,n.jsxs)("div",{children:[(0,n.jsx)("strong",{children:"步骤 5："})," 点击“新增账号”按钮完成保存"]}),(0,n.jsx)("div",{style:{marginTop:"0.5rem",color:"#1890ff",fontWeight:"500"},children:"\uD83D\uDCA1 提示：系统会自动解析 JSON 数据并保存账号信息。如果账号已存在（根据 open_id 判断），将自动更新；不存在则新增。字段不存在时会自动创建。"})]})}),(0,n.jsxs)(r.T,{vertical:!0,spacing:"loose",style:{width:"100%"},children:[(0,n.jsxs)("div",{children:[(0,n.jsx)("div",{style:{marginBottom:"0.5rem",fontSize:"14px",fontWeight:"500"},children:"TikTok 授权链接"}),(0,n.jsx)(r.II,{id:"tiktok-auth-link-input",value:l.h3,readOnly:!0,style:{width:"100%",marginBottom:"0.5rem"},onFocus:e=>{e.target.select()}}),(0,n.jsxs)(r.T,{style:{width:"100%"},children:[(0,n.jsx)(r.zx,{theme:"solid",type:"primary",onClick:x,style:{flex:1},children:"复制链接"}),(0,n.jsx)(r.zx,{theme:"borderless",type:"tertiary",onClick:j,style:{flex:1},children:"在新窗口打开"})]})]}),(0,n.jsx)(r.l0.Select,{field:"table",label:"选择账号列表",placeholder:"请选择账号列表",style:{width:"100%"},rules:[{required:!0,message:"请选择账号列表"}],children:Array.isArray(e)&&e.map(e=>{let{name:t,id:o}=e;return(0,n.jsx)(r.l0.Select.Option,{value:o,children:t},o)})}),(0,n.jsx)(r.l0.TextArea,{field:"jsonData",label:"授权返回的JSON数据",placeholder:"请将授权完成后返回的JSON数据粘贴到这里...",rows:8,style:{width:"100%"},rules:[{required:!0,message:"请输入JSON数据"}]}),(0,n.jsx)(r.zx,{theme:"solid",type:"primary",htmlType:"submit",loading:m,style:{width:"100%"},children:"新增账号"}),(0,n.jsxs)("div",{style:{margin:"1rem 0",borderTop:"1px solid #e8e8e8",paddingTop:"1rem"},children:[(0,n.jsx)(d,{heading:5,style:{marginBottom:"0.5rem",fontSize:"16px"},children:"批量更新账号信息"}),(0,n.jsxs)("div",{style:{marginBottom:"1rem",fontSize:"14px",color:"#666",lineHeight:"1.6"},children:[(0,n.jsxs)("div",{children:[(0,n.jsx)("strong",{children:"功能说明："})," 批量同步账号列表中的所有 TikTok 账号信息，包括粉丝数、获赞数、视频数等数据"]}),(0,n.jsxs)("div",{style:{marginTop:"0.5rem"},children:[(0,n.jsx)("strong",{children:"操作步骤："}),(0,n.jsxs)("div",{style:{marginLeft:"1rem",marginTop:"0.25rem"},children:[(0,n.jsx)("div",{children:"1. 确保账号列表已选择（当前选中的数据表）"}),(0,n.jsx)("div",{children:"2. 点击下方“更新所有账号信息”按钮"}),(0,n.jsx)("div",{children:"3. 系统将自动遍历所有账号记录并更新信息"})]})]}),(0,n.jsx)("div",{style:{marginTop:"0.5rem",color:"#fa8c16",fontWeight:"500"},children:"⚠️ 注意：此操作会调用 TikTok API 更新所有账号，可能需要较长时间，请耐心等待"})]}),(0,n.jsx)(r.zx,{theme:"solid",type:"secondary",onClick:b,loading:p,style:{width:"100%"},children:"更新所有账号信息"})]})]})]})]})}}}]);