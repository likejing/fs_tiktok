"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[899],{4696:function(e,t,o){o.d(t,{Bl:function(){return i},N4:function(){return l},NG:function(){return c},Qt:function(){return s},_i:function(){return d},cZ:function(){return n},dH:function(){return a},h3:function(){return r}});let r="https://www.tiktok.com/v2/auth/authorize?client_key=7519030880531447825&scope=biz.brand.insights%2Ccomment.list%2Cuser.info.basic%2Cuser.info.username%2Cuser.info.stats%2Cuser.info.profile%2Cuser.account.type%2Cuser.insights%2Cvideo.list%2Cvideo.insights%2Ccomment.list.manage%2Cvideo.publish%2Cvideo.upload%2Cbiz.spark.auth%2Cdiscovery.search.words%2Cbiz.ads.recommend%2Cbiz.creator.info%2Cbiz.creator.insights%2Ctto.campaign.link&response_type=code&redirect_uri=https%3A%2F%2Fltexpress.huokechuangxin.cn%2FgetOpenTkToken",n="/api/getTkUserInfo",a="/api/getTkVideoList",c="/api/refreshTkToken",i="/api/getPublishStatus",l="/api/generateApimart",s="/api/getApimartTaskStatus",d="/api/fetchSocialVideo"},6078:function(e,t,o){o.d(t,{Gv:function(){return c},Hl:function(){return i},o$:function(){return n},tI:function(){return a}});var r=o(7017);async function n(e,t,o){try{let r=await e.getCellString(t.id,o);if(r)return String(r).trim()}catch(r){try{let r=await e.getCellValue(t.id,o);if(Array.isArray(r)){let e=r.map(e=>"string"==typeof e?e:e&&"object"==typeof e&&(e.text||e.link)||"").join("");return e.trim()||null}if(null!=r)return String(r).trim()}catch(e){console.warn("获取字段 ".concat(t.name," 的值失败:"),r,e)}}return null}function a(e){return"number"==typeof e?r.fS.Number:"boolean"==typeof e?r.fS.Checkbox:r.fS.Text}async function c(e,t){let o;try{o=await e.getType()}catch(e){console.warn("获取字段类型失败，默认使用文本类型:",e),o=r.fS.Text}let n=null;if(o===r.fS.Text)null!=t&&(n="object"==typeof t?JSON.stringify(t):String(t));else if(o===r.fS.Number){let e=Number(t);!isNaN(e)&&isFinite(e)?n=e:(console.warn("值 ".concat(t," 无法转换为数字，尝试保存为文本")),n=String(t))}else o===r.fS.Checkbox?n=!!t:null!=t&&(n="object"==typeof t?JSON.stringify(t):String(t));return n}async function i(e,t,o,r){let n=t.find(e=>e.name===o);if(n)return n;try{if(n=await e.getFieldByName(o)){let e=t.findIndex(e=>e.id===n.id);return -1===e&&t.push(n),n}}catch(e){}if(void 0!==r)try{let a=await e.addField({type:r,name:o});try{n=await e.getFieldById(a)}catch(t){n=await e.getFieldByName(o)}let c=await e.getFieldList(),i=c.find(e=>e.id===a||e.name===o);if(i){let e=t.findIndex(e=>e.id===i.id);return -1===e?t.push(i):t[e]=i,i}if(n)return t.push(n),n}catch(r){console.warn("创建字段 ".concat(o," 失败:"),r);try{if(n=await e.getFieldByName(o)){let e=t.findIndex(e=>e.id===n.id);return -1===e&&t.push(n),n}}catch(e){console.error("获取字段 ".concat(o," 失败:"),e)}}return null}},8899:function(e,t,o){o.r(t),o.d(t,{default:function(){return u}});var r=o(5893),n=o(7017),a=o(4905),c=o(7294),i=o(6078),l=o(4696);let{Title:s,Text:d}=a.Typography;function u(){let[e,t]=(0,c.useState)(),[o,u]=(0,c.useState)(),[g,f]=(0,c.useState)(!1),[h,w]=(0,c.useState)(!1),[y,p]=(0,c.useState)(0),[m,_]=(0,c.useState)(""),k=(0,c.useRef)(),I=async(e,t,o)=>{try{let r=await e.getFieldById(t.id),n=await r.getValue(o);if(Array.isArray(n)&&n.length>0){let e=await r.getAttachmentUrls(o);return n.map((t,o)=>({url:e[o]||t.url||t.token||"",name:t.name||"unknown",size:t.size||0})).filter(e=>e.url)}return[]}catch(e){return console.error("获取附件临时下载链接失败:",e),[]}},S=async(e,t,o)=>{try{let r=await fetch("/api/uploadToOSS",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({fileUrl:e,fileName:t,folder:o||"tiktok-videos"})}),n=await r.json();if(0===n.code&&n.data&&n.data.url)return n.data.url;throw Error(n.error||n.message||"上传到OSS失败")}catch(e){throw console.error("上传到OSS失败:",e),e}},T=async(e,t,o)=>{try{console.log("正在获取发布状态 - publish_id: ".concat(o));let r=await fetch("".concat(l.Bl,"?access_token=").concat(encodeURIComponent(e),"&business_id=").concat(encodeURIComponent(t),"&publish_id=").concat(encodeURIComponent(o))),n=await r.json();if(0===n.code&&n.data)return console.log("✅ 获取发布状态成功: ".concat(n.data.status)),n.data;throw Error(n.error||n.message||"获取发布状态失败")}catch(e){throw console.error("获取发布状态失败:",e),e}},b=async e=>{try{console.log("正在刷新Token...");let t=await fetch(l.NG,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refresh_token:e})}),o=await t.json();if(0===o.code&&o.data)return console.log("✅ Token刷新成功"),o.data;throw Error(o.error||o.message||"刷新Token失败")}catch(e){throw console.error("刷新Token失败:",e),e}},N=async(e,t,o,r,c,l)=>{try{console.log("查找账号信息 - open_id: ".concat(r));let s=await e.getRecords({pageSize:5e3});for(let d of(console.log("账号列表中共有 ".concat(s.records.length," 条记录")),s.records)){let s=await (0,i.o$)(e,o,d.recordId),u=s?String(s).trim():"",g=String(r).trim();if(console.log("检查记录 ".concat(d.recordId,': open_id = "').concat(u,'" (目标: "').concat(g,'")')),u===g){let o=await (0,i.o$)(e,t,d.recordId),s=o?String(o).trim():"";if(console.log("✅ 找到匹配账号 - recordId: ".concat(d.recordId,", access_token: ").concat(s?s.substring(0,30)+"...":"(空)")),l)try{let o=await (0,i.o$)(e,l,d.recordId),r=!1,u=Date.now();if(o){let e=new Date(o).getTime(),t=e-u;console.log("Token失效时间检查: ".concat(new Date(e).toLocaleString(),", 剩余时间: ").concat(Math.round(t/1e3/60),"分钟")),t<3e5&&(r=!0,console.log("⚠️ Token即将失效或已失效，准备刷新..."))}else r=!0,console.log("⚠️ 账号记录中没有 token失效时间，将尝试刷新Token并补全该字段");if(r){if(c){let o=await (0,i.o$)(e,c,d.recordId);if(o)try{let r=await b(String(o).trim()),i={};if(i[t.id]=r.access_token,c&&r.refresh_token&&(i[c.id]=r.refresh_token),l&&r.expires_in){let e=u+1e3*r.expires_in,t=new Date(e);try{let o=await l.getType();o===n.fS.Number?(i[l.id]=e,console.log("新的Token失效时间(时间戳): ".concat(e," (").concat(t.toLocaleString(),")"))):(i[l.id]=t.toISOString(),console.log("新的Token失效时间(ISO): ".concat(t.toISOString()," (").concat(t.toLocaleString(),")")))}catch(e){console.warn("获取 token失效时间 字段类型失败，按字符串写入:",e),i[l.id]=t.toISOString(),console.log("新的Token失效时间(回退ISO): ".concat(t.toISOString()," (").concat(t.toLocaleString(),")"))}}await e.setRecord(d.recordId,{fields:i}),console.log("✅ 已更新账号列表中的Token信息"),s=r.access_token,a.FN.success("Token已自动刷新并更新到账号列表")}catch(e){console.error("❌ Token刷新失败:",e),a.FN.warning("Token刷新失败: ".concat(e.message||"未知错误","，请手动更新Token"))}else console.warn("⚠️ 未找到refresh_token，无法刷新Token")}else console.warn("⚠️ 账号列表中未找到refresh_token字段，无法自动刷新Token")}}catch(e){console.warn("检查Token失效时间失败:",e)}return s?s.length<10&&console.warn("⚠️ 账号 ".concat(d.recordId," 的 access_token 格式可能不正确 (长度: ").concat(s.length,")")):console.warn("⚠️ 账号 ".concat(d.recordId," 的 access_token 为空")),{recordId:d.recordId,openId:r,accessToken:s}}}return console.warn("❌ 未找到匹配的账号 - open_id: ".concat(r)),null}catch(e){return console.error("获取账号信息失败:",e),null}},F=(0,c.useCallback)(async e=>{let{materialTable:t,accountTable:o}=e;if(!t){a.FN.error("请先选择素材库表");return}if(!o){a.FN.error("请先选择账号列表");return}f(!0),p(0),_("开始查询待发布素材...");let r=0,c=0,l=0;try{let e=await n.ws.base.getTableById(t),d=await n.ws.base.getTableById(o),u=await e.getFieldList(),g=null,h=null,w=null,y=null;for(let e of u)try{let t=await e.getName();"发布状态"===t?g=e:"发布时间"===t?h=e:"发布账号"===t?w=e:"视频附件"===t&&(y=e)}catch(e){console.warn("获取字段名称失败:",e)}if(!g)try{g=await e.getFieldByName("发布状态")}catch(e){console.warn("发布状态字段不存在")}if(!h)try{h=await e.getFieldByName("发布时间")}catch(e){console.warn("发布时间字段不存在")}if(!w)try{w=await e.getFieldByName("发布账号")}catch(e){console.warn("发布账号字段不存在")}if(!y)try{y=await e.getFieldByName("视频附件")}catch(e){console.warn("视频附件字段不存在")}if(!g){a.FN.error('素材库表中未找到"发布状态"字段'),f(!1);return}if(!h){a.FN.error('素材库表中未找到"发布时间"字段'),f(!1);return}if(!w){a.FN.error('素材库表中未找到"发布账号"字段'),f(!1);return}if(!y){a.FN.error('素材库表中未找到"视频附件"字段'),f(!1);return}let m=await d.getFieldList(),k=null,b=null,F=null,C=null;for(let e of m)try{let t=await e.getName();"access_token"===t?k=e:"open_id"===t?b=e:"refresh_token"===t||"刷新令牌"===t?F=e:("token失效时间"===t||"token_expires_time"===t||"expires_time"===t)&&(C=e)}catch(e){console.warn("获取字段名称失败:",e)}if(!k)try{k=await d.getFieldByName("access_token")}catch(e){console.warn("access_token字段不存在")}if(!b)try{b=await d.getFieldByName("open_id")}catch(e){console.warn("open_id字段不存在")}if(!F)try{F=await d.getFieldByName("refresh_token")}catch(e){console.warn("refresh_token字段不存在")}if(!C)try{C=await d.getFieldByName("token失效时间")}catch(e){console.warn("token失效时间字段不存在")}if(!k||!b){a.FN.error("账号列表中未找到 access_token 或 open_id 字段"),f(!1);return}F||console.warn("⚠️ 账号列表中未找到 refresh_token 字段，将无法自动刷新Token"),C||console.warn("⚠️ 账号列表中未找到 token失效时间 字段，将无法判断Token是否失效"),_("查询待发布素材...");let x=await e.getRecords({pageSize:5e3}),v=new Date,j=[];for(let t of x.records)try{let o=await (0,i.o$)(e,g,t.recordId);if(!o||"等待发布"!==String(o).trim())continue;try{let o=await e.getCellValue(h.id,t.recordId);if(o){let e=null;if("number"==typeof o?e=new Date(o):"string"==typeof o?e=new Date(o):o&&"object"==typeof o&&(e=new Date(o.timestamp?o.timestamp:o)),e&&e>v)continue}}catch(e){console.warn("获取发布时间失败 (记录 ".concat(t.recordId,"):"),e);continue}j.push(t)}catch(e){console.error("检查记录 ".concat(t.recordId," 失败:"),e)}if(console.log("找到 ".concat(j.length," 条待发布素材")),0===j.length){a.FN.info("没有符合条件的待发布素材"),f(!1);return}_("找到 ".concat(j.length," 条待发布素材，开始处理..."));for(let t=0;t<j.length;t++){let o=j[t];p(Math.round((t+1)/j.length*100)),_("正在处理素材 ".concat(t+1,"/").concat(j.length,"..."));try{var s;let f=await (0,i.o$)(e,w,o.recordId);if(!f){console.log("记录 ".concat(o.recordId," 没有发布账号，跳过")),l++;continue}let h=String(f).trim(),p=await N(d,k,b,h,F,C);if(!p||!p.accessToken){console.log("记录 ".concat(o.recordId," 无法获取账号信息 (open_id: ").concat(h,")，跳过")),a.FN.warning("素材 ".concat(o.recordId," 无法获取账号信息，请检查账号列表中是否存在 open_id: ").concat(h)),l++;continue}let m=String(p.accessToken).trim();if(!m||m.length<10){console.error("记录 ".concat(o.recordId," 的 access_token 格式无效: ").concat(m.substring(0,20),"...")),a.FN.error("素材 ".concat(o.recordId," 的 access_token 格式无效，请更新账号信息")),c++;continue}console.log("✅ 获取到账号信息 - open_id: ".concat(h,", access_token: ").concat(m.substring(0,20),"..."));let x=await I(e,y,o.recordId);if(0===x.length){console.log("记录 ".concat(o.recordId," 没有视频附件，跳过")),l++;continue}let v=null;for(let e of u)try{let t=await e.getName();if("caption"===t||"标题"===t||"title"===t){v=e;break}}catch(e){}if(!v)try{v=await e.getFieldByName("标题")}catch(t){try{v=await e.getFieldByName("caption")}catch(e){}}let O="";v&&(O=await (0,i.o$)(e,v,o.recordId)||"");let B=null,L=null,A=null,E=null,P=null;for(let e of u)try{let t=await e.getName();"视频链接"===t||"video_url"===t?B=e:"封面链接"===t||"custom_thumbnail_url"===t?L=e:"is_brand_organic"===t?A=e:"is_branded_content"===t?E=e:("是否AI生成"===t||"AI生成"===t||"is_ai_generated"===t)&&(P=e)}catch(e){}let V=!1;if(P)try{let t=await (0,i.o$)(e,P,o.recordId);if(t){let e=String(t).trim().toLowerCase();V="true"===e||"是"===e||"yes"===e||"1"===e}}catch(e){console.warn("获取是否AI生成字段失败:",e)}let D="";if(B){let t=await (0,i.o$)(e,B,o.recordId);t&&(D=String(t).trim())}if(!D&&x.length>0){_("正在上传视频到OSS ".concat(t+1,"/").concat(j.length,"..."));try{let t=x[0];console.log("开始上传视频到OSS: ".concat(t.name," (").concat(t.size," bytes)"));let r=await S(t.url,t.name,"tiktok-videos");if(console.log("✅ 视频上传到OSS成功: ".concat(r)),D=r,B)try{await e.setCellValue(B.id,o.recordId,r),console.log("✅ 已更新视频链接字段: ".concat(r))}catch(e){console.warn("更新视频链接字段失败:",e)}else try{let t=await e.addField({type:n.fS.Text,name:"视频链接"}),a="string"==typeof t?t:t.id;await e.setCellValue(a,o.recordId,r),console.log("✅ 已创建并更新视频链接字段: ".concat(r)),"string"!=typeof t&&(B=t)}catch(e){console.warn("创建视频链接字段失败:",e)}}catch(e){console.error("❌ 上传视频到OSS失败:",e),a.FN.error("上传视频到OSS失败: ".concat(e.message||"未知错误")),c++;continue}}if(!D){console.log("记录 ".concat(o.recordId," 没有有效的视频URL，跳过")),l++;continue}let $="";if(L){let t=await (0,i.o$)(e,L,o.recordId);t&&($=String(t).trim())}let z=!1;if(A)try{let t=await e.getFieldById(A.id),r=await t.getValue(o.recordId);if(r){let e="object"==typeof r?r.text:r;z="true"===String(e).toLowerCase()}}catch(r){let t=await (0,i.o$)(e,A,o.recordId);t&&(z="true"===String(t).toLowerCase())}let R=!1;if(E)try{let t=await e.getFieldById(E.id),r=await t.getValue(o.recordId);if(r){let e="object"==typeof r?r.text:r;R="true"===String(e).toLowerCase()}}catch(r){let t=await (0,i.o$)(e,E,o.recordId);t&&(R="true"===String(t).toLowerCase())}let U={access_token:m,business_id:h,video_url:D,custom_thumbnail_url:$||void 0,post_info:{caption:O||"",is_brand_organic:z,is_branded_content:R,is_ai_generated:V,disable_comment:!1,disable_duet:!1,disable_stitch:!1}};console.log("准备发布素材 ".concat(o.recordId,":"),{...U,access_token:"***"}),console.log("发布参数详情:",{recordId:o.recordId,openId:h,accessTokenLength:m.length,accessTokenPrefix:m.substring(0,30)+"...",videoUrl:D,caption:(null===(s=O)||void 0===s?void 0:s.substring(0,50))+"..."});try{console.log("正在调用发布API...");let n=await fetch("/api/publishVideo",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(U)});console.log("发布API响应状态: ".concat(n.status," ").concat(n.statusText));let i=await n.json();if(console.log("发布API返回结果:",{code:i.code,message:i.message,error:i.error,error_code:i.error_code}),0===i.code&&i.data){let n=i.data.share_id;console.log("✅ 素材 ".concat(o.recordId," 发布成功，share_id: ").concat(n));try{let r=g;if(r)try{let t=await e.getFieldById(r.id);try{await t.setValue(o.recordId,"发布中")}catch(e){try{await t.setValue(o.recordId,"已发布")}catch(e){console.warn("更新发布状态失败:",e)}}}catch(e){console.warn("获取状态字段失败:",e)}let c=null;for(let e of u)try{let t=await e.getName();if("share_id"===t||"publish_id"===t){c=e;break}}catch(e){}if(c)try{await e.setCellValue(c.id,o.recordId,n),console.log("✅ 已保存 share_id: ".concat(n))}catch(e){console.warn("保存 share_id 失败:",e)}try{_("正在获取素材 ".concat(t+1,"/").concat(j.length," 的发布状态..."));let r=await T(m,h,n);if(r&&r.status){let t=r.status;console.log("发布状态: ".concat(t));let n="发布中";if("PUBLISH_COMPLETE"===t)n="已发布";else if("FAILED"===t){n="发布失败";let e=r.reason||"未知原因";console.error("发布失败原因: ".concat(e)),a.FN.warning("素材 ".concat(o.recordId," 发布失败: ").concat(e))}else("PROCESSING_DOWNLOAD"===t||"SEND_TO_USER_INBOX"===t)&&(n="发布中");if(g)try{let t=await e.getFieldById(g.id);await t.setValue(o.recordId,n),console.log("✅ 已更新发布状态为: ".concat(n))}catch(e){console.warn("更新发布状态失败:",e)}if("PUBLISH_COMPLETE"===t&&r.post_ids&&Array.isArray(r.post_ids)&&r.post_ids.length>0){let t=null;for(let e of u)try{let o=await e.getName();if("post_ids"===o||"post_id"===o){t=e;break}}catch(e){}if(t)try{let n=r.post_ids.join(",");await e.setCellValue(t.id,o.recordId,n),console.log("✅ 已保存 post_ids: ".concat(n))}catch(e){console.warn("保存 post_ids 失败:",e)}}}}catch(e){console.warn("获取发布状态失败:",e)}}catch(e){console.warn("更新记录状态失败:",e)}r++}else{let t=i.message||i.error||"发布失败",r=i.error_code||i.code;console.error("❌ 素材 ".concat(o.recordId," 发布失败:"),t);let n=t.toLowerCase().includes("access token")||t.toLowerCase().includes("token")||t.toLowerCase().includes("revoked")||t.toLowerCase().includes("expired")||40101===r||40102===r;n?(console.error("⚠️ Access Token 已过期或无效，请更新账号列表中的 access_token"),a.FN.warning({content:"素材 ".concat(o.recordId,' 发布失败：Access Token 已过期或无效，请前往"账号管理"页面更新该账号的 access_token'),duration:5e3})):a.FN.error("素材 ".concat(o.recordId," 发布失败: ").concat(t));try{let t=g;if(t)try{let r=await e.getFieldById(t.id);await r.setValue(o.recordId,"发布失败")}catch(e){console.warn("更新发布状态失败:",e)}}catch(e){console.warn("更新记录状态失败:",e)}c++}}catch(e){console.error("发布素材 ".concat(o.recordId," 时出错:"),e),c++}}catch(e){console.error("处理素材 ".concat(o.recordId," 失败:"),e),c++}}let O="处理完成！成功: ".concat(r,"，跳过: ").concat(l,"，失败: ").concat(c);0===c?a.FN.success(O):a.FN.warning(O),_(O)}catch(e){console.error("自动发布失败:",e),a.FN.error("发布失败: ".concat(e.message||"未知错误")),_("发布失败: ".concat(e.message||"未知错误"))}finally{f(!1),p(0)}},[]),C=(0,c.useCallback)(async()=>{var e,t;let o=null===(e=k.current)||void 0===e?void 0:e.getValues(),r=null==o?void 0:o.materialTable,c=null==o?void 0:o.accountTable;if(!r){a.FN.error("请先选择素材库表");return}if(!c){a.FN.error("请先选择账号列表");return}w(!0),p(0),_("开始查询发布中的素材...");let l=0,s=0,d=0;try{let e=await n.ws.base.getTableById(r),o=await n.ws.base.getTableById(c),u=await e.getFieldList(),g=await o.getFieldList(),f=null,h=null,y=null,m=null;for(let e of u)try{let t=await e.getName();"发布状态"===t?f=e:"发布账号"===t?h=e:"share_id"===t||"publish_id"===t?y=e:("post_ids"===t||"post_id"===t)&&(m=e)}catch(e){}if(!f){a.FN.error('素材库表中未找到"发布状态"字段'),w(!1);return}if(!y){a.FN.error('素材库表中未找到"share_id"或"publish_id"字段'),w(!1);return}let k=null,I=null;for(let e of g)try{let t=await e.getName();"access_token"===t?k=e:"open_id"===t&&(I=e)}catch(e){}if(!k||!I){a.FN.error("账号列表中未找到 access_token 或 open_id 字段"),w(!1);return}_("查询发布中的素材...");let S=await e.getRecords({pageSize:5e3}),b=[];for(let t of S.records){let o=await (0,i.o$)(e,f,t.recordId);if("发布中"===o){let o=await (0,i.o$)(e,y,t.recordId);o?b.push({record:t,shareId:o}):(console.log("记录 ".concat(t.recordId," 没有 share_id，跳过")),d++)}}if(console.log("找到 ".concat(b.length," 条发布中的素材")),0===b.length){a.FN.info("没有找到发布中的素材"),w(!1);return}_("找到 ".concat(b.length," 条发布中的素材，开始更新状态..."));for(let r=0;r<b.length;r++){let{record:n,shareId:a}=b[r];p(Math.round((r+1)/b.length*100)),_("正在更新素材 ".concat(r+1,"/").concat(b.length," 的发布状态..."));try{let r=null;if(h){let a=await (0,i.o$)(e,h,n.recordId);if(a)r=String(a).trim(),console.log("从发布账号字段获取到 open_id: ".concat(r));else try{let a=await e.getCellValue(h.id,n.recordId);if(Array.isArray(a)&&a.length>0){let e=a[0],n=null===(t=e.recordIds)||void 0===t?void 0:t[0];n&&(r=await (0,i.o$)(o,I,n),console.log("从关联记录获取到 open_id: ".concat(r)))}else"string"==typeof a&&a.trim()&&(r=a.trim(),console.log("从关联字段值获取到 open_id: ".concat(r)))}catch(e){console.warn("获取发布账号字段值失败:",e)}}if(!r){console.log("记录 ".concat(n.recordId," 没有有效的发布账号 open_id，跳过")),d++;continue}let c=await N(o,k,I,r,null,null);if(!c||!c.accessToken){console.log("记录 ".concat(n.recordId," 无法获取账号信息 (open_id: ").concat(r,")，跳过")),d++;continue}let u=await T(c.accessToken,r,a);if(u&&u.status){let t=u.status;console.log("素材 ".concat(n.recordId," 发布状态: ").concat(t));let o="发布中";if("PUBLISH_COMPLETE"===t)o="已发布";else if("FAILED"===t){o="发布失败";let e=u.reason||"未知原因";console.error("发布失败原因: ".concat(e))}else("PROCESSING_DOWNLOAD"===t||"SEND_TO_USER_INBOX"===t)&&(o="发布中");try{let t=await e.getFieldById(f.id);await t.setValue(n.recordId,o),console.log("✅ 已更新发布状态为: ".concat(o)),l++}catch(e){console.warn("更新发布状态失败:",e),s++}if("PUBLISH_COMPLETE"===t&&u.post_ids&&Array.isArray(u.post_ids)&&u.post_ids.length>0&&m)try{let t=u.post_ids.join(",");await e.setCellValue(m.id,n.recordId,t),console.log("✅ 已保存 post_ids: ".concat(t))}catch(e){console.warn("保存 post_ids 失败:",e)}}else console.warn("记录 ".concat(n.recordId," 获取发布状态失败")),s++}catch(e){console.error("更新素材 ".concat(n.recordId," 发布状态失败:"),e),s++}}let F="更新完成！成功: ".concat(l,"，跳过: ").concat(d,"，失败: ").concat(s);0===s?a.FN.success(F):a.FN.warning(F),_(F)}catch(e){console.error("更新发布状态失败:",e),a.FN.error("更新失败: ".concat(e.message||"未知错误")),_("更新失败: ".concat(e.message||"未知错误"))}finally{w(!1),p(0)}},[]);return(0,c.useEffect)(()=>{Promise.all([n.ws.base.getTableMetaList(),n.ws.base.getSelection()]).then(e=>{var o,r,n;let[a,c]=e;t(a),u(a);let i=(null===(o=a.find(e=>"素材库"===e.name))||void 0===o?void 0:o.id)||c.tableId,l=(null===(r=a.find(e=>"账号列表"===e.name))||void 0===r?void 0:r.id)||c.tableId;null===(n=k.current)||void 0===n||n.setValues({materialTable:i,accountTable:l})})},[]),(0,r.jsxs)("div",{children:[(0,r.jsx)(s,{heading:4,style:{marginBottom:"1rem"},children:"TikTok 素材发布管理"}),(0,r.jsx)(d,{type:"tertiary",style:{marginBottom:"1rem",display:"block"},children:"自动化发布 TikTok 视频素材，支持定时发布、批量发布、自动 Token 刷新等功能，让您的视频内容管理更高效。"}),(0,r.jsxs)(a.l0,{labelPosition:"top",onSubmit:F,getFormApi:e=>k.current=e,style:{marginTop:"1rem"},children:[(0,r.jsx)(a.l0.Slot,{label:"使用说明",children:(0,r.jsxs)("div",{style:{marginBottom:"1rem",fontSize:"14px",color:"#666",lineHeight:"1.6"},children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("strong",{children:"功能说明："})," 自动发布素材库中符合条件的视频到 TikTok，支持定时发布、自动上传视频到 OSS、自动刷新 Token 等"]}),(0,r.jsxs)("div",{style:{marginTop:"0.5rem"},children:[(0,r.jsx)("strong",{children:"操作步骤："}),(0,r.jsxs)("div",{style:{marginLeft:"1rem",marginTop:"0.25rem"},children:[(0,r.jsx)("div",{children:"1. 选择素材库表（包含发布状态、发布时间、发布账号、视频附件等字段）"}),(0,r.jsx)("div",{children:"2. 选择账号列表（包含 access_token 和 open_id 字段）"}),(0,r.jsx)("div",{children:"3. 点击“自动发布”按钮开始发布流程"}),(0,r.jsx)("div",{children:"4. 系统会自动查询符合条件的素材并发布到 TikTok"})]})]}),(0,r.jsx)("div",{style:{marginTop:"0.5rem",color:"#1890ff",fontWeight:"500"},children:"\uD83D\uDCA1 发布条件：发布状态 = “等待发布” 且 发布时间 ≤ 当前时间。系统会自动检查 Token 是否过期，过期前会自动刷新。"}),(0,r.jsx)("div",{style:{marginTop:"0.5rem",color:"#fa8c16",fontWeight:"500"},children:"⚠️ 注意：发布操作会调用 TikTok API，请确保素材已准备好视频附件和标题等信息"})]})}),(0,r.jsxs)(a.T,{vertical:!0,spacing:"loose",style:{width:"100%"},children:[(0,r.jsx)(a.l0.Select,{field:"materialTable",label:"选择素材库表",placeholder:"请选择素材库表",style:{width:"100%"},rules:[{required:!0,message:"请选择素材库表"}],children:Array.isArray(e)&&e.map(e=>{let{name:t,id:o}=e;return(0,r.jsx)(a.l0.Select.Option,{value:o,children:t},o)})}),(0,r.jsx)(a.l0.Select,{field:"accountTable",label:"选择账号列表",placeholder:"请选择账号列表",style:{width:"100%"},rules:[{required:!0,message:"请选择账号列表"}],children:Array.isArray(o)&&o.map(e=>{let{name:t,id:o}=e;return(0,r.jsx)(a.l0.Select.Option,{value:o,children:t},o)})}),(0,r.jsx)(a.zx,{theme:"solid",type:"primary",htmlType:"submit",loading:g,style:{width:"100%"},children:"自动发布"}),(0,r.jsx)(a.zx,{theme:"borderless",type:"tertiary",onClick:C,loading:h,style:{width:"100%",marginTop:"0.5rem"},children:"更新发布状态"}),(g||h)&&(0,r.jsxs)("div",{style:{marginTop:"1rem"},children:[(0,r.jsx)(a.Ex,{percent:y,type:"line",size:"small"}),(0,r.jsx)(d,{style:{marginTop:"0.5rem",display:"block"},children:m})]})]})]})]})}}}]);