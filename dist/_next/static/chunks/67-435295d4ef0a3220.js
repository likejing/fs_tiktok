"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[67],{9067:function(t,e,a){a.r(e),a.d(e,{default:function(){return u}});var o=a(5893),r=a(7017),l=a(4905),c=a(7294),n=a(6078),i=a(4696);let{Title:s,Text:d}=l.Typography;function u(){let[t,e]=(0,c.useState)(),[a,u]=(0,c.useState)(!1),[g,h]=(0,c.useState)(0),[w,y]=(0,c.useState)(""),m=(0,c.useRef)(),f=async(t,e,a)=>{try{let o=await t.getFieldById(e.id),r=await o.getValue(a);if(Array.isArray(r)&&r.length>0){let t=await o.getAttachmentUrls(a);return r.map((e,a)=>({url:t[a]||e.url||e.token||"",name:e.name||"unknown"})).filter(t=>t.url)}return[]}catch(t){return console.error("获取附件临时下载链接失败:",t),[]}},p=async(t,e,a)=>{try{let o=await fetch(i.XS,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({fileUrl:t,fileName:e,folder:a||"sora-images"})}),r=await o.json();if(0===r.code&&r.data&&r.data.url)return r.data.url;throw Error(r.error||r.message||"上传到OSS失败")}catch(t){throw console.error("上传到OSS失败:",t),t}},S=(t,e)=>{let a=t||"横屏",o=a.includes("竖屏")||a.toLowerCase().includes("portrait"),r=o?"9:16":"16:9",l=e||"10s",c=10;c=l.includes("25")?25:l.includes("15")?15:10;let n=c>=25?"sora-2-pro":"sora-2";return console.log("生成参数: 横竖屏=".concat(a,", 时长=").concat(l,", aspect_ratio=").concat(r,", duration=").concat(c,", model=").concat(n)),{aspect_ratio:r,duration:c,model:n}},v=async t=>{try{var e,a,o,r;console.log("提交生成任务，payload:",JSON.stringify({...t,image_urls:(null===(e=t.image_urls)||void 0===e?void 0:e.length)||0,image_urls_preview:(null===(a=t.image_urls)||void 0===a?void 0:a.slice(0,2))||[]}));let l=Date.now(),c=new AbortController,n=setTimeout(()=>c.abort(),9e4),s=await fetch(i.N4,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t),signal:c.signal});clearTimeout(n);let d=Date.now()-l;if(console.log("请求耗时: ".concat(d,"ms, 状态码: ").concat(s.status)),!s.ok){let t="",e={};try{e=await s.json(),t=(null===(o=e)||void 0===o?void 0:o.error)||(null===(r=e)||void 0===r?void 0:r.message)||"HTTP ".concat(s.status)}catch(e){t=await s.text().catch(()=>"HTTP ".concat(s.status))}if(524===s.status)throw Error("请求超时（".concat(d,"ms）：网关超时。可能原因：1) 图片 URL 无法被 Apimart API 访问（需要公网可访问的 URL）；2) 服务器处理时间过长。请检查图片 URL 或稍后重试"));throw console.error("API 错误响应:",s.status,t,e),Error("请求失败 (".concat(s.status,"): ").concat(t))}let u=await s.json();if(console.log("API 响应数据:",JSON.stringify(u)),0!==u.code&&200!==u.code){let t=(null==u?void 0:u.error)||(null==u?void 0:u.message)||"未知错误";throw Error("业务错误 (code: ".concat(u.code,"): ").concat(t))}let g=u.data;if(!g)throw Error("未返回任务数据，响应: "+JSON.stringify(u));let h=Array.isArray(g)?g[0]:g;if(!(null==h?void 0:h.task_id))throw Error("未返回任务ID，响应数据: "+JSON.stringify(g));return console.log("✅ 任务创建成功: task_id=".concat(h.task_id,", status=").concat(h.status)),{status:h.status||"submitted",task_id:h.task_id}}catch(t){if("AbortError"===t.name)throw Error("请求超时：超过 90 秒未响应，请检查网络连接或图片 URL 是否可访问");throw console.error("createApimartTask 错误:",t),t}},k=async t=>{let e="".concat(i.Qt,"?task_id=").concat(encodeURIComponent(t),"&language=zh"),a=await fetch(e),o=await a.json();if(!a.ok||0!==o.code){let t=(null==o?void 0:o.error)||(null==o?void 0:o.message)||"请求失败: ".concat(a.status);throw Error(t)}return o.data},x=(0,c.useCallback)(async t=>{let{table:e}=t;if(!e){l.FN.error("请先选择数据表");return}u(!0),h(0),y("开始提交AI视频生成任务...");let a=0,o=0,c=0;try{let t=await r.ws.base.getTableById(e),i=await t.getFieldList(),s=null,d=null,g=null,w=null,m=null,k=null,x=null,b=null;for(let t of i)try{let e=await t.getName();"文本提示词"===e||"prompt"===e?s=t:"参考图"===e||"reference_image"===e?d=t:"Sora2视频"===e||"sora2_video"===e?g=t:"是否生成Sora"===e||"should_generate"===e?w=t:"横竖屏"===e||"orientation"===e?m=t:"生成时长"===e||"duration"===e?k=t:"任务ID"===e||"task_id"===e||"Task ID"===e?x=t:("生成状态"===e||"状态"===e||"string"==typeof e&&"status"===e.toLowerCase())&&(b=t)}catch(t){console.warn("获取字段名称失败:",t)}if(!s)try{s=await t.getFieldByName("文本提示词")}catch(t){console.warn("文本提示词字段不存在")}if(!d)try{d=await t.getFieldByName("参考图")}catch(t){console.warn("参考图字段不存在")}if(!g)try{g=await t.getFieldByName("Sora2视频")}catch(e){if(!(g=await (0,n.Hl)(t,i,"Sora2视频",r.fS.Attachment))){l.FN.error("无法创建或获取 Sora2视频 字段"),u(!1);return}i=await t.getFieldList()}if(!w)try{w=await t.getFieldByName("是否生成Sora")}catch(t){console.warn("是否生成Sora字段不存在")}if(!m)try{m=await t.getFieldByName("横竖屏")}catch(t){console.warn("横竖屏字段不存在")}if(!k)try{k=await t.getFieldByName("生成时长")}catch(t){console.warn("生成时长字段不存在")}if(x||(x=await (0,n.Hl)(t,i,"任务ID",r.fS.Text),i=await t.getFieldList()),b||(b=await (0,n.Hl)(t,i,"生成状态",r.fS.Text),i=await t.getFieldList()),!s){l.FN.error('数据表中未找到"文本提示词"字段'),u(!1);return}d||console.warn('未找到"参考图"字段，将仅支持文生视频');let j=await t.getRecords({pageSize:5e3}),A=j.records.length;console.log("开始处理 ".concat(A," 条记录"));for(let e=0;e<A;e++){let r=j.records[e],i=r.recordId;h(Math.round((e+1)/A*100)),y("正在处理记录 ".concat(e+1,"/").concat(A,"..."));try{if(w){let e=await (0,n.o$)(t,w,i);if("是"!==e&&"true"!==e&&"True"!==e){console.log("记录 ".concat(i,' 的"是否生成Sora"为否，跳过')),o++;continue}}if(g)try{let e=await t.getFieldById(g.id),a=await e.getValue(i);if(Array.isArray(a)&&a.length>0){console.log("记录 ".concat(i," 已有Sora2视频，跳过")),o++;continue}}catch(t){console.warn("检查已有视频失败:",t)}if(x)try{let e=await (0,n.o$)(t,x,i);if(e){console.log("记录 ".concat(i," 已有任务ID(").concat(e,")，跳过提交")),o++;continue}}catch(t){console.warn("检查任务ID失败:",t)}let e=await (0,n.o$)(t,s,i);if(!e){console.log("记录 ".concat(i," 缺少文本提示词，跳过")),o++;continue}let r=m?await (0,n.o$)(t,m,i):null,u=k?await (0,n.o$)(t,k,i):null,{aspect_ratio:h,duration:j,model:A}=S(r,u),T=d?await f(t,d,i):[];console.log("处理记录 ".concat(i,"，提示词: ").concat(e,"，参考图数量: ").concat(T.length));let I=[];if(T.length>0){y("正在上传 ".concat(T.length," 张图片到 OSS..."));let t=0,e=0;for(let a=0;a<T.length;a++){let o=T[a];try{console.log("上传图片 ".concat(a+1,"/").concat(T.length,": ").concat(o.name)),y("正在上传图片 ".concat(a+1,"/").concat(T.length,"..."));let e=await p(o.url,o.name,"sora-images");I.push(e),t++,console.log("✅ 图片上传成功: ".concat(e))}catch(t){e++,console.error("上传图片 ".concat(o.name," 失败:"),t),l.FN.warning("记录 ".concat(i,' 的图片 "').concat(o.name,'" 上传到 OSS 失败: ').concat(t.message||"未知错误"))}}if(0===I.length&&T.length>0){console.warn("⚠️ 所有图片上传失败，跳过该记录"),l.FN.error("记录 ".concat(i," 的所有图片上传失败，跳过生成")),c++;continue}e>0&&l.FN.warning("记录 ".concat(i,": 成功上传 ").concat(t," 张，失败 ").concat(e," 张")),console.log("✅ 成功上传 ".concat(I.length,"/").concat(T.length," 张图片到 OSS")),console.log("OSS URLs:",I)}y("正在提交生成任务...");let N=await v({model:A,prompt:e,duration:j,aspect_ratio:h,private:!1,watermark:!1,image_urls:I.length>0?I:void 0});x&&await t.setCellValue(x.id,i,N.task_id),b&&await t.setCellValue(b.id,i,N.status||"submitted"),console.log("✅ 记录 ".concat(i," 任务创建成功，task_id=").concat(N.task_id,", status=").concat(N.status)),a++}catch(t){console.error("处理记录 ".concat(i," 失败:"),t),c++,l.FN.error("记录 ".concat(i," 生成失败: ").concat(t.message||"未知错误"))}}l.FN.success("生成完成！成功: ".concat(a,"，跳过: ").concat(o,"，失败: ").concat(c)),y("生成完成！成功: ".concat(a,"，跳过: ").concat(o,"，失败: ").concat(c))}catch(t){console.error("生成Sora2视频失败:",t),l.FN.error("生成失败: ".concat(t.message||"未知错误")),y("生成失败: ".concat(t.message||"未知错误"))}finally{u(!1),h(0)}},[]),b=(0,c.useCallback)(async t=>{let{table:e}=t;if(!e){l.FN.error("请先选择数据表");return}u(!0),h(0),y("开始更新任务状态...");let a=0,o=0,c=0;try{let t=await r.ws.base.getTableById(e),i=await t.getFieldList(),s=null,d=null,g=null;for(let t of i)try{let e=await t.getName();"任务ID"===e||"task_id"===e||"Task ID"===e?s=t:"生成状态"===e||"状态"===e||"string"==typeof e&&"status"===e.toLowerCase()?d=t:("Sora2视频"===e||"sora2_video"===e)&&(g=t)}catch(t){console.warn("获取字段名称失败:",t)}if(!s){l.FN.error("未找到“任务ID”字段，无法更新任务状态"),u(!1);return}let w=await t.getRecords({pageSize:5e3}),m=w.records.length;for(let e=0;e<m;e++){let r=w.records[e],l=r.recordId;h(Math.round((e+1)/m*100)),y("正在更新任务状态 ".concat(e+1,"/").concat(m,"..."));try{let e=await (0,n.o$)(t,s,l);if(!e)continue;let r=await k(String(e).trim()),c=r.status||"";if(a++,d&&await t.setCellValue(d.id,l,c),"completed"===c&&g&&r.result&&Array.isArray(r.result.videos)){let e=await t.getFieldById(g.id);try{let t=await e.getValue(l);if(Array.isArray(t)&&t.length>0){console.log("记录 ".concat(l," 状态已完成且已有视频附件，跳过保存")),o++;continue}}catch(t){console.warn("检查记录 ".concat(l," 现有附件失败:"),t)}let a=r.result.videos[0],c=null==a?void 0:a.url,n=Array.isArray(c)?c[0]:null;if(n)try{let t=await fetch(n);if(!t.ok)throw Error("下载视频失败: ".concat(t.status," ").concat(t.statusText));let a=await t.blob(),r="sora2_video_".concat(Date.now(),".mp4"),c=new File([a],r,{type:"video/mp4"});await e.setValue(l,c),o++,console.log("✅ 记录 ".concat(l," 状态完成并已保存视频附件"))}catch(t){console.error("记录 ".concat(l," 保存视频失败:"),t)}}}catch(t){c++,console.error("更新记录 ".concat(l," 任务状态失败:"),t)}}l.FN.success("任务状态更新完成！更新: ".concat(a,"，已完成并保存视频: ").concat(o,"，失败: ").concat(c)),y("任务状态更新完成！更新: ".concat(a,"，已完成并保存视频: ").concat(o,"，失败: ").concat(c))}catch(t){console.error("更新任务状态失败:",t),l.FN.error("更新任务状态失败: ".concat(t.message||"未知错误")),y("更新任务状态失败: ".concat(t.message||"未知错误"))}finally{u(!1),h(0)}},[]);return(0,c.useEffect)(()=>{Promise.all([r.ws.base.getTableMetaList(),r.ws.base.getSelection()]).then(t=>{var a;let[o,r]=t;e(o);let l=o.find(t=>"AI素材生成"===t.name),c=(null==l?void 0:l.id)||r.tableId;c&&(null===(a=m.current)||void 0===a||a.setValues({table:c}))})},[]),(0,o.jsxs)("div",{children:[(0,o.jsx)(s,{heading:4,style:{marginBottom:"1rem"},children:"TikTok AI 视频生成"}),(0,o.jsx)(d,{type:"tertiary",style:{marginBottom:"1rem",display:"block"},children:"使用 Sora2 AI 模型生成高质量视频内容，支持文本提示词、参考图片、自定义时长和横竖屏比例，为您的 TikTok 内容创作提供强大的 AI 支持。"}),(0,o.jsxs)(l.l0,{getFormApi:t=>m.current=t,style:{width:"100%"},children:[(0,o.jsx)(l.l0.Slot,{label:"使用说明",children:(0,o.jsxs)("div",{style:{marginBottom:"1rem",fontSize:"14px",color:"#666",lineHeight:"1.6"},children:[(0,o.jsxs)("div",{children:[(0,o.jsx)("strong",{children:"功能说明："})," 基于 Sora2 AI 模型，根据文本提示词和参考图片自动生成视频内容，支持自定义视频时长和横竖屏比例"]}),(0,o.jsxs)("div",{style:{marginTop:"0.5rem"},children:[(0,o.jsx)("strong",{children:"操作步骤："}),(0,o.jsxs)("div",{style:{marginLeft:"1rem",marginTop:"0.25rem"},children:[(0,o.jsx)("div",{children:"1. 在数据表中填写“文本提示词”字段（必填）"}),(0,o.jsx)("div",{children:"2. 可选：上传“参考图”附件，AI 将参考图片生成视频"}),(0,o.jsx)("div",{children:"3. 可选：设置“横竖屏”和“生成时长”字段"}),(0,o.jsx)("div",{children:"4. 点击“生成Sora2视频”按钮提交生成任务"}),(0,o.jsx)("div",{children:"5. 使用“更新任务状态”按钮查询生成进度并下载完成的视频"})]})]}),(0,o.jsx)("div",{style:{marginTop:"0.5rem",color:"#1890ff",fontWeight:"500"},children:"\uD83D\uDCA1 提示：生成任务提交后会返回任务ID，视频生成需要一定时间。请定期点击“更新任务状态”查询进度，完成后会自动下载并保存到“Sora2视频”附件字段。"}),(0,o.jsx)("div",{style:{marginTop:"0.5rem",color:"#fa8c16",fontWeight:"500"},children:"⚠️ 注意：如果记录已有任务ID，将跳过生成；如果生成状态为“已完成”且已有视频附件，将跳过状态更新"})]})}),(0,o.jsxs)(l.T,{vertical:!0,spacing:"loose",style:{width:"100%"},children:[(0,o.jsx)(l.l0.Select,{field:"table",label:"选择数据表",placeholder:"请选择数据表",style:{width:"100%"},rules:[{required:!0,message:"请选择数据表"}],children:Array.isArray(t)&&t.map(t=>{let{name:e,id:a}=t;return(0,o.jsx)(l.l0.Select.Option,{value:a,children:e},a)})}),(0,o.jsx)(l.zx,{theme:"solid",type:"primary",onClick:()=>{var t;let e=(null===(t=m.current)||void 0===t?void 0:t.getValues())||{};x({table:e.table})},loading:a,style:{width:"100%"},children:"生成Sora2视频"}),(0,o.jsx)(l.zx,{theme:"solid",type:"secondary",onClick:()=>{var t;let e=(null===(t=m.current)||void 0===t?void 0:t.getValues())||{};b({table:e.table})},loading:a,style:{width:"100%"},children:"更新任务状态"}),a&&(0,o.jsxs)("div",{style:{marginTop:"1rem"},children:[(0,o.jsx)(l.Ex,{percent:g,type:"line",size:"small"}),(0,o.jsx)(d,{style:{marginTop:"0.5rem",display:"block"},children:w})]})]})]})]})}}}]);