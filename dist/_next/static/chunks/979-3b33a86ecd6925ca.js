"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[979],{979:function(e,t,o){o.r(t),o.d(t,{default:function(){return u}});var n=o(5893),r=o(7017),i=o(4905),a=o(7294),c=o(4696),l=o(6078);let{Title:s,Text:d}=i.Typography,g={caption:"标题",comments:"评论数",favorites:"收藏数",likes:"点赞数",total_time_watched:"观看总时长",video_views:"视频浏览量",shares:"视频分享数",full_video_watched_rate:"完播率",average_time_watched:"平均观看时长"},h={retentionWeight:.6,likeWeight:.4,highlightFrame:{minLikePercentage:.05,topN:5},highlightSegment:{minRetentionPercentage:.7,minSegmentDuration:3,maxSegmentDuration:15,mergeThreshold:2}},m=["item_id","create_time","thumbnail_url","share_url","embed_url","caption","video_views","likes","comments","shares","favorites","reach","video_duration","full_video_watched_rate","total_time_watched","average_time_watched","impression_sources","audience_countries","media_type","video_view_retention","engagement_likes"];function u(){let[e,t]=(0,a.useState)(),[o,u]=(0,a.useState)(),[f,k]=(0,a.useState)(!1),[p,_]=(0,a.useState)(0),[w,y]=(0,a.useState)(""),T=(0,a.useRef)(),v=(0,a.useCallback)(async e=>{try{console.log("正在刷新Token...");let t=await fetch(c.NG,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refresh_token:e})}),o=await t.json();if(0===o.code&&o.data)return console.log("✅ Token刷新成功"),o.data;throw Error(o.error||o.message||"刷新Token失败")}catch(e){throw console.error("刷新Token失败:",e),e}},[]),x=(0,a.useCallback)(async(e,t,o)=>{try{let n=await e.getRecords({pageSize:5e3});for(let r of n.records){let n=await (0,l.o$)(e,t,r.recordId);if(n&&String(n).trim()===String(o).trim())return r.recordId}return null}catch(e){return console.warn("查找视频记录失败:",e),null}},[]),S=(0,a.useCallback)(async e=>{let{accountTable:t,videoTable:o}=e;if(!t){i.FN.error("请先选择账号列表");return}if(!o){i.FN.error("请先选择视频列表");return}k(!0),_(0),y("开始获取视频列表...");let n=0,a=0,s=0,d=0;try{let e=await r.ws.base.getTableById(t),u=await r.ws.base.getTableById(o),f=await e.getFieldList();console.log("账号列表字段:",f.map(e=>({id:e.id,name:e.name})));let p=f.find(e=>"access_token"===e.name),w=f.find(e=>"open_id"===e.name),T=null,S=null;for(let e of f)try{let t=await e.getName();"refresh_token"===t||"刷新令牌"===t?T=e:("token失效时间"===t||"token_expires_time"===t||"expires_time"===t)&&(S=e)}catch(e){console.warn("获取字段名称失败:",e)}if(!T)try{T=await e.getFieldByName("refresh_token")}catch(e){console.warn("refresh_token字段不存在")}if(!S)try{S=await e.getFieldByName("token失效时间")}catch(e){console.warn("token失效时间字段不存在")}if(T?console.log("✅ 找到 refresh_token 字段"):console.warn("⚠️ 账号列表中未找到 refresh_token 字段，将无法自动刷新Token"),S?console.log("✅ 找到 token失效时间 字段"):console.warn("⚠️ 账号列表中未找到 token失效时间 字段，将无法判断Token是否失效（将在API调用失败时尝试刷新）"),p)console.log("找到 access_token 字段:",p.id);else try{if(p=await e.getFieldByName("access_token")){console.log("通过 getFieldByName 找到 access_token 字段");let e=f.findIndex(e=>e.id===p.id);-1===e&&f.push(p)}}catch(e){console.warn("access_token字段不存在:",e)}if(w)console.log("找到 open_id 字段:",w.id);else try{if(w=await e.getFieldByName("open_id")){console.log("通过 getFieldByName 找到 open_id 字段");let e=f.findIndex(e=>e.id===w.id);-1===e&&f.push(w)}}catch(e){console.warn("open_id字段不存在:",e)}if(!p){let e=f.map(e=>e.name).join(", ");i.FN.error("账号列表中未找到 access_token 字段。当前字段: ".concat(e||"无")),console.error("账号列表字段列表:",e),k(!1);return}if(!w){let e=f.map(e=>e.name).join(", ");i.FN.error("账号列表中未找到 open_id 字段。当前字段: ".concat(e||"无")),console.error("账号列表字段列表:",e),k(!1);return}let b=await u.getFieldList(),j=await (0,l.Hl)(u,b,"item_id",r.fS.Text);if(!j){i.FN.error("无法创建或获取 item_id 字段"),k(!1);return}b=await u.getFieldList();let F=await (0,l.Hl)(u,b,"open_id",r.fS.Text);if(!F){i.FN.error("无法创建或获取 open_id 字段"),k(!1);return}b=await u.getFieldList();let N=await e.getRecords({pageSize:5e3}),I=N.records.length;console.log("开始处理 ".concat(I," 个账号的视频列表"));for(let t=0;t<I;t++){let o=N.records[t],f=o.recordId;_(Math.round((t+1)/I*100)),y("正在处理账号 ".concat(t+1,"/").concat(I,"..."));try{let o,k=await (0,l.o$)(e,p,f),_=await (0,l.o$)(e,w,f);if(!k||!_){console.log("账号 ".concat(t+1," 缺少 access_token 或 open_id，跳过")),a++;continue}let y=String(k).trim(),N=async()=>{if(console.log("开始尝试刷新Token..."),!T)return console.warn("⚠️ 账号列表中未找到refresh_token字段，无法自动刷新Token"),!1;{let o=await (0,l.o$)(e,T,f);if(!o)return console.warn("⚠️ 未找到refresh_token值，无法刷新Token"),!1;try{console.log("找到refresh_token，开始刷新...");let n=await v(String(o).trim()),r=Date.now(),a={};if(p&&(a[p.id]=n.access_token),T&&n.refresh_token&&(a[T.id]=n.refresh_token),S&&n.expires_in){let e=new Date(r+1e3*n.expires_in);a[S.id]=e.toISOString(),console.log("新的Token失效时间: ".concat(e.toLocaleString()))}return await e.setRecord(f,{fields:a}),console.log("✅ 已更新账号列表中的Token信息"),y=n.access_token,i.FN.success("账号 ".concat(t+1," Token已自动刷新并更新到账号列表")),!0}catch(e){return console.error("❌ Token刷新失败:",e),i.FN.warning("账号 ".concat(t+1," Token刷新失败: ").concat(e.message||"未知错误","，请手动更新Token")),!1}}};if(S)try{let t=await (0,l.o$)(e,S,f);if(t){let e=new Date(t).getTime(),o=Date.now(),n=e-o;console.log("Token失效时间检查: ".concat(new Date(e).toLocaleString(),", 剩余时间: ").concat(Math.round(n/1e3/60),"分钟")),n<3e5&&(console.log("⚠️ Token即将失效或已失效，尝试刷新..."),await N())}else console.log("⚠️ Token失效时间字段为空，无法判断是否失效")}catch(e){console.warn("检查Token失效时间失败:",e)}else console.log("⚠️ 未找到token失效时间字段，跳过失效检查（将在API调用失败时尝试刷新）");console.log("获取账号 ".concat(t+1," (open_id: ").concat(_,") 的视频列表..."));let I=!0,A=0;for(;I;)try{let e="".concat(c.dH,"?access_token=").concat(encodeURIComponent(y),"&business_id=").concat(encodeURIComponent(_),"&fields=").concat(encodeURIComponent(JSON.stringify(m)),"&max_count=20");void 0!==o&&(e+="&cursor=".concat(o)),console.log("请求视频列表，URL: ".concat(e.replace(/access_token=[^&]+/,"access_token=***")));let n=await fetch(e);if(!n.ok){let e=await n.text();throw Error("请求失败: ".concat(n.status," ").concat(n.statusText," - ").concat(e))}let i=await n.json();if(0!==i.code){let e=i.message||i.error||"获取视频列表失败";if(e.includes("Access token")||e.includes("token")||e.includes("revoked")){console.log("⚠️ 检测到Token错误: ".concat(e,"，尝试刷新Token并重试..."));let t=await N();if(t){console.log("✅ Token已刷新，重新执行当前请求...");continue}throw Error("Token刷新失败: ".concat(e))}throw Error(e)}if(!i.data||!i.data.videos){console.log("账号 ".concat(t+1," 没有视频数据"));break}let a=i.data.videos;for(let e of(console.log("账号 ".concat(t+1," 获取到 ").concat(a.length," 个视频")),a))try{let t=await x(u,j,e.item_id),o={};o[F.id]=_;let n=[],i=[];try{let t=e.video_view_retention,a=e.engagement_likes;if(a&&(n=function(e){if(!Array.isArray(e)||0===e.length)return[];let t=e.map(e=>({second:parseInt(e.second||"0",10),percentage:parseFloat(e.percentage||"0"),score:parseFloat(e.percentage||"0")*h.likeWeight})).filter(e=>e.percentage>=h.highlightFrame.minLikePercentage).sort((e,t)=>t.score-e.score).slice(0,h.highlightFrame.topN);return t}(a)),t&&(i=function(e,t){if(!Array.isArray(e)||0===e.length)return[];let o=new Map;e.forEach(e=>{let t=parseInt(e.second||"0",10),n=parseFloat(e.percentage||"0");o.set(t,{retention:n,like:0})}),Array.isArray(t)&&t.forEach(e=>{let t=parseInt(e.second||"0",10),n=parseFloat(e.percentage||"0");o.has(t)?o.get(t).like=n:o.set(t,{retention:0,like:n})});let n=Array.from(o.entries()).map(e=>{let[t,o]=e;return{second:t,retention:o.retention,like:o.like,score:o.retention*h.retentionWeight+o.like*h.likeWeight}}).sort((e,t)=>e.second-t.second),r=[],i=null;for(let e of n){let t=e.score>=h.highlightSegment.minRetentionPercentage*h.retentionWeight;if(t)i?(i.end=e.second,i.scores.push(e.score),i.retentions.push(e.retention),i.likes.push(e.like)):i={start:e.second,end:e.second,scores:[e.score],retentions:[e.retention],likes:[e.like]};else if(i){let e=i.end-i.start;if(e>=h.highlightSegment.minSegmentDuration){let e=i.scores.reduce((e,t)=>e+t,0)/i.scores.length,t=i.retentions.reduce((e,t)=>e+t,0)/i.retentions.length,o=i.likes.reduce((e,t)=>e+t,0)/i.likes.length;r.push({start:i.start,end:i.end,score:e,avgRetention:t,avgLike:o})}i=null}}if(i){let e=i.end-i.start;if(e>=h.highlightSegment.minSegmentDuration){let e=i.scores.reduce((e,t)=>e+t,0)/i.scores.length,t=i.retentions.reduce((e,t)=>e+t,0)/i.retentions.length,o=i.likes.reduce((e,t)=>e+t,0)/i.likes.length;r.push({start:i.start,end:i.end,score:e,avgRetention:t,avgLike:o})}}let a=[];for(let e of r)if(0===a.length)a.push(e);else{let t=a[a.length-1],o=e.start-t.end;o<=h.highlightSegment.mergeThreshold?(t.end=e.end,t.score=(t.score+e.score)/2,t.avgRetention=(t.avgRetention+e.avgRetention)/2,t.avgLike=(t.avgLike+e.avgLike)/2):a.push(e)}return a.filter(e=>e.end-e.start<=h.highlightSegment.maxSegmentDuration).sort((e,t)=>t.score-e.score)}(t,a||[])),n.length>0){let e=await (0,l.Hl)(u,b,"highlight_frames",r.fS.Text);if(e){let t=n.map(e=>"".concat(e.second,"秒")).join(", ");o[e.id]=t,console.log("✅ 计算高光帧: ".concat(n.length," 个 - ").concat(t))}}if(i.length>0){let e=await (0,l.Hl)(u,b,"highlight_segments",r.fS.Text);if(e){let t=i.map(e=>"".concat(e.start,"~").concat(e.end,"秒")).join(", ");o[e.id]=t,console.log("✅ 计算高光片段: ".concat(i.length," 个 - ").concat(t))}}}catch(t){console.warn("计算高光帧/片段失败 (视频 ".concat(e.item_id,"):"),t)}for(let[t,n]of Object.entries(e))try{if("item_id"===t){j&&(o[j.id]=String(n));continue}let e=g[t]||t,r=n;null!=n&&(Array.isArray(n)||"object"==typeof n&&n.constructor===Object)&&(r=JSON.stringify(n));let i=await (0,l.Hl)(u,b,e,(0,l.tI)(r));if(!i){console.warn("字段 ".concat(t," -> ").concat(e," 不存在且创建失败，跳过"));continue}let a=await (0,l.Gv)(i,r);null!=a&&(o[i.id]=a,console.log("字段 ".concat(t," -> ").concat(e," (").concat(i.id,") 保存值:"),a))}catch(e){console.error("处理视频字段 ".concat(t," 时出错:"),e)}t?(await u.setRecord(t,{fields:o}),console.log("✅ 更新视频 ".concat(e.item_id))):(await u.addRecord({fields:o}),console.log("✅ 新增视频 ".concat(e.item_id)),d++)}catch(t){console.error("处理视频 ".concat(e.item_id," 时出错:"),t),s++}if(I=!0===i.data.has_more,o=i.data.cursor,++A>=50){console.log("账号 ".concat(t+1," 已获取 ").concat(A," 页，停止获取"));break}I&&await new Promise(e=>setTimeout(e,500))}catch(e){console.error("获取账号 ".concat(t+1," 的视频列表失败:"),e),s++;break}n++}catch(e){console.error("处理账号 ".concat(t+1," 失败:"),e),s++}}let A="获取完成！成功: ".concat(n,"，跳过: ").concat(a,"，失败: ").concat(s,"，新增视频: ").concat(d);0===s?i.FN.success(A):i.FN.warning(A),y(A)}catch(e){console.error("获取视频列表失败:",e),i.FN.error("获取失败: ".concat(e.message||"未知错误")),y("获取失败: ".concat(e.message||"未知错误"))}finally{k(!1),_(0)}},[x,v]);return(0,a.useEffect)(()=>{Promise.all([r.ws.base.getTableMetaList(),r.ws.base.getSelection()]).then(e=>{var o,n,r;let[i,a]=e;t(i),u(i);let c=(null===(o=i.find(e=>"账号列表"===e.name))||void 0===o?void 0:o.id)||a.tableId,l=(null===(n=i.find(e=>"视频列表"===e.name))||void 0===n?void 0:n.id)||a.tableId;null===(r=T.current)||void 0===r||r.setValues({accountTable:c,videoTable:l})})},[]),(0,n.jsxs)("div",{children:[(0,n.jsx)(s,{heading:4,style:{marginBottom:"1rem"},children:"TikTok 视频数据分析"}),(0,n.jsx)(d,{type:"tertiary",style:{marginBottom:"1rem",display:"block"},children:"批量获取 TikTok 账号的视频数据，包括播放量、点赞数、评论数、分享数等关键指标，并自动计算视频高光帧和高光片段，帮助您分析视频表现。"}),(0,n.jsxs)(i.l0,{labelPosition:"top",onSubmit:S,getFormApi:e=>T.current=e,style:{marginTop:"1rem"},children:[(0,n.jsx)(i.l0.Slot,{label:"使用说明",children:(0,n.jsxs)("div",{style:{marginBottom:"1rem",fontSize:"14px",color:"#666",lineHeight:"1.6"},children:[(0,n.jsxs)("div",{children:[(0,n.jsx)("strong",{children:"功能说明："})," 从 TikTok API 获取账号的所有视频数据，包括播放量、点赞数、评论数、分享数、完播率等详细指标"]}),(0,n.jsxs)("div",{style:{marginTop:"0.5rem"},children:[(0,n.jsx)("strong",{children:"操作步骤："}),(0,n.jsxs)("div",{style:{marginLeft:"1rem",marginTop:"0.25rem"},children:[(0,n.jsx)("div",{children:"1. 选择账号列表（包含 access_token 和 open_id 字段的数据表）"}),(0,n.jsx)("div",{children:"2. 选择视频列表（用于保存视频数据的数据表）"}),(0,n.jsx)("div",{children:"3. 点击“获取视频列表”按钮开始同步"}),(0,n.jsx)("div",{children:"4. 系统将自动遍历所有账号，获取每个账号的视频数据并保存"})]})]}),(0,n.jsx)("div",{style:{marginTop:"0.5rem",color:"#1890ff",fontWeight:"500"},children:"\uD83D\uDCA1 提示：系统会自动创建所需字段。如果视频已存在（通过 item_id 判断），将自动更新数据；不存在则新增记录。系统还会自动计算视频的高光帧和高光片段，帮助您快速定位视频亮点。"}),(0,n.jsx)("div",{style:{marginTop:"0.5rem",color:"#fa8c16",fontWeight:"500"},children:"⚠️ 注意：此操作会调用 TikTok API 获取所有账号的视频数据，可能需要较长时间，请耐心等待"})]})}),(0,n.jsxs)(i.T,{vertical:!0,spacing:"loose",style:{width:"100%"},children:[(0,n.jsx)(i.l0.Select,{field:"accountTable",label:"选择账号列表",placeholder:"请选择账号列表",style:{width:"100%"},rules:[{required:!0,message:"请选择账号列表"}],children:Array.isArray(e)&&e.map(e=>{let{name:t,id:o}=e;return(0,n.jsx)(i.l0.Select.Option,{value:o,children:t},o)})}),(0,n.jsx)(i.l0.Select,{field:"videoTable",label:"选择视频列表",placeholder:"请选择视频列表",style:{width:"100%"},rules:[{required:!0,message:"请选择视频列表"}],children:Array.isArray(o)&&o.map(e=>{let{name:t,id:o}=e;return(0,n.jsx)(i.l0.Select.Option,{value:o,children:t},o)})}),(0,n.jsx)(i.zx,{theme:"solid",type:"primary",htmlType:"submit",loading:f,style:{width:"100%"},children:"获取视频列表"}),f&&(0,n.jsxs)("div",{style:{marginTop:"1rem"},children:[(0,n.jsx)(i.Ex,{percent:p,type:"line",size:"small"}),(0,n.jsx)(d,{style:{marginTop:"0.5rem",display:"block"},children:w})]})]})]})]})}}}]);